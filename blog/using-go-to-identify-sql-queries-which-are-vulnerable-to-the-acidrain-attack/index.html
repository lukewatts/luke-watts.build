<!DOCTYPE html><html lang="en" data-theme="lofi"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v3.6.3"><!-- Primary Meta Tags --><title>Using Go to identify SQL queries which are vulnerable to the ACIDRain attack</title><meta name="title" content="Using Go to identify SQL queries which are vulnerable to the ACIDRain attack"><meta name="description" content="How you use Go's concurrency features to check if your MySQL/Postgres queries are vulnerable to an ACIDRain attack"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://luke-watts.com/blog/using-go-to-identify-sql-queries-which-are-vulnerable-to-the-acidrain-attack/"><meta property="og:title" content="Using Go to identify SQL queries which are vulnerable to the ACIDRain attack"><meta property="og:description" content="How you use Go's concurrency features to check if your MySQL/Postgres queries are vulnerable to an ACIDRain attack"><meta property="og:image" content="https://luke-watts.com/images/mysql-logo.jpeg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://luke-watts.com/blog/using-go-to-identify-sql-queries-which-are-vulnerable-to-the-acidrain-attack/"><meta property="twitter:title" content="Using Go to identify SQL queries which are vulnerable to the ACIDRain attack"><meta property="twitter:description" content="How you use Go's concurrency features to check if your MySQL/Postgres queries are vulnerable to an ACIDRain attack"><meta property="twitter:image" content="https://luke-watts.com/images/mysql-logo.jpeg"><link rel="stylesheet" href="/_astro/_page_.8a26929d.css" />
<style>.time-line-container>div:last-child .education__time>.education__line{display:none}.call_to_action{padding-top:.5rem;padding-bottom:.5rem;font-size:1.125rem;line-height:1.75rem}.call_to_action>p{margin-bottom:.5rem}
</style></head> <body> <div class="bg-base-100 drawer lg:drawer-open"> <input id="my-drawer" type="checkbox" class="drawer-toggle"> <div class="drawer-content bg-base-100"> <div class="sticky lg:hidden top-0 z-30 flex h-16 w-full justify-center bg-opacity-90 backdrop-blur transition-all duration-100 bg-base-100 text-base-content shadow-sm"> <div class="navbar"> <div class="navbar-start"> <label for="my-drawer" class="btn btn-square btn-ghost"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-5 h-5 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path> </svg> </label> </div> <div class="navbar-center"> <a class="btn btn-ghost normal-case text-xl" href="/">Luke Watts ⚡️</a> </div> <div class="navbar-end"></div> </div> </div> <div class="md:flex md:justify-center"> <main class="p-6 pt-10 lg:max-w-[900px] max-w-[100vw]">  <main class="md:flex md:justify-center"> <article class="prose prose-lg max-w-[750px] prose-img:mx-auto"> <img src="/images/mysql-logo.jpeg" alt="Using Go to identify SQL queries which are vulnerable to the ACIDRain attack" class="w-full mb-6" width="750" height="422" loading="lazy" decoding="async"> <h1 class="title my-2 text-4xl font-bold">Using Go to identify SQL queries which are vulnerable to the ACIDRain attack</h1> <time>Feb 22, 2024</time> <br>  <a href="/blog/tag/go" class="badge badge-outline ml-2 no-underline"> go </a><a href="/blog/tag/sql" class="badge badge-outline ml-2 no-underline"> sql </a><a href="/blog/tag/mysql" class="badge badge-outline ml-2 no-underline"> mysql </a><a href="/blog/tag/concurrency" class="badge badge-outline ml-2 no-underline"> concurrency </a><a href="/blog/tag/security" class="badge badge-outline ml-2 no-underline"> security </a><a href="/blog/tag/ACIDRain attack" class="badge badge-outline ml-2 no-underline"> ACIDRain attack </a>  <div class="divider my-2"></div>  <p>In this post, I will show you how to use Go to test MySQL/Postgres queries for
race conditions and phantom reads. This is a very important part of testing your
queries, especially in a large scale multi-user environment.</p>
<h2 id="disclaimer">Disclaimer</h2>
<p>I’m a relatively new to Go myself (3 months in), so if you see any mistakes in my code or something which could be improved, please let me know by leaving a comment on <a href="https://gist.github.com/lukewatts/15e6c74b4c7f6427a02e2cc10707bc5c#new_comment_field">this gist</a> which contains all the code in this article.</p>
<p>I wrote this code primarily to replicate the ACIDRain attack so I could quickly confirm without any doubt that a series of queries (most likely in a code review) would be susceptible to the attack or not, and so I could easily demonstrate the result of the issue.</p>
<h2 id="pre-requisites">Pre-requisites</h2>
<ol>
<li><a href="https://go.dev/doc/install">Go installed</a> and configured correctly on your environment</li>
<li>A MySQL (or Postgres) database, and the ability to create a new database and tables, and read and write to that database</li>
<li>A basic understanding of concurrency in Go using <a href="https://gobyexample.com/channels">Channels</a> and <a href="https://gobyexample.com/waitgroups">WaitGroups</a></li>
<li>(Optional) Some basic understanding of Laravel (or any other PHP framework) to understand the example code</li>
</ol>
<p>This post assumes you have a basic understanding of Go (mainly Channels and WaitGroups) and SQL (mainly MySQL). If you don’t, you can still use the code provided to check your queries, but you may not understand the code fully. I will try to explain as much as I can, but I won’t be able to explain everything in detail. Especially not Channels and WaitGroups in Go. However I will link to additonal resources where you can learn more about these topics.</p>
<h2 id="what-are-race-conditions">What are race conditions?</h2>
<p>Let’s start by defining the issue we are trying to identify. A race condition (a concept at the core of the ACIDRain attack) in an SQL database, is a situation in which two or more threads, processes, sessions, or requests read a unit of data at the same time, with the intention of using that unit of data to update something else (the database and other systems). This can lead to a situation where the data is not consistent, and the result of the update is not what was expected. This is a very common issue in large-scale multi-user environments, and it is very important to be able to quickly identify and proove it is possible.</p>
<h2 id="why-you-need-to-guard-yourself-from-race-conditions">Why you need to guard yourself from race conditions?</h2>
<p>Let’s take a look at an example to understand. This will be the example we will use throughout this post.</p>
<p><strong>NOTE: In this example we will use MySQL, but the same principles also apply to Postgres. However, this is not something which is possible on SQLite, as SQLite locks the entire database when a read/write happens.</strong></p>
<p>Here is our example table:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> TABLE</span><span style="color:#E1E4E8"> `</span><span style="color:#B392F0">users</span><span style="color:#E1E4E8">` (</span></span>
<span class="line"><span style="color:#9ECBFF">  `id`</span><span style="color:#F97583"> bigint</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">20</span><span style="color:#E1E4E8">) unsigned </span><span style="color:#F97583">NOT NULL</span><span style="color:#E1E4E8"> AUTO_INCREMENT,</span></span>
<span class="line"><span style="color:#9ECBFF">  `name`</span><span style="color:#F97583"> varchar</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">255</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">COLLATE</span><span style="color:#E1E4E8"> utf8mb4_unicode_ci </span><span style="color:#F97583">NOT NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">  `email`</span><span style="color:#F97583"> varchar</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">255</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">COLLATE</span><span style="color:#E1E4E8"> utf8mb4_unicode_ci </span><span style="color:#F97583">NOT NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">  `email_verified_at`</span><span style="color:#F97583"> timestamp</span><span style="color:#F97583"> NULL</span><span style="color:#F97583"> DEFAULT</span><span style="color:#F97583"> NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">  `password`</span><span style="color:#F97583"> varchar</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">255</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">COLLATE</span><span style="color:#E1E4E8"> utf8mb4_unicode_ci </span><span style="color:#F97583">NOT NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">  `balance`</span><span style="color:#F97583"> decimal</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">8</span><span style="color:#E1E4E8">,</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">NOT NULL</span><span style="color:#F97583"> DEFAULT</span><span style="color:#9ECBFF"> '100.00'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">  `remember_token`</span><span style="color:#F97583"> varchar</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">COLLATE</span><span style="color:#E1E4E8"> utf8mb4_unicode_ci </span><span style="color:#F97583">DEFAULT</span><span style="color:#F97583"> NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">  `created_at`</span><span style="color:#F97583"> timestamp</span><span style="color:#F97583"> NULL</span><span style="color:#F97583"> DEFAULT</span><span style="color:#F97583"> NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">  `updated_at`</span><span style="color:#F97583"> timestamp</span><span style="color:#F97583"> NULL</span><span style="color:#F97583"> DEFAULT</span><span style="color:#F97583"> NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">  PRIMARY KEY</span><span style="color:#E1E4E8"> (</span><span style="color:#9ECBFF">`id`</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#F97583">  UNIQUE</span><span style="color:#F97583"> KEY</span><span style="color:#9ECBFF"> `users_email_unique`</span><span style="color:#E1E4E8"> (</span><span style="color:#9ECBFF">`email`</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">) ENGINE</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">InnoDB AUTO_INCREMENT</span><span style="color:#F97583">=</span><span style="color:#79B8FF">1</span><span style="color:#F97583"> DEFAULT</span><span style="color:#E1E4E8"> CHARSET</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">utf8mb4 </span><span style="color:#F97583">COLLATE=</span><span style="color:#E1E4E8">utf8mb4_unicode_ci</span></span></code></pre>
<p><strong>NOTE: I am using Laravel to create, migrate and seed my database for this example. However, we will only be using the id and balance fields throughout this article.</strong></p>
<h2 id="a-simple-withdrawl">A simple withdrawl</h2>
<p>Now let’s say we have a simple situation where a system/process is requesting to withdraw from this users balance.</p>
<p>Here are the steps we would take:</p>
<ol>
<li>Requested user starts with a balance of 100.00. The requester want to withdraw 100.00.</li>
<li>Our system checks the requested users balance is greater than or equal to the amount requested using a simple SELECT query.</li>
<li>The system confirms the user has enough in their balance, so it begins the withdrawl/transfer process.
<ol>
<li>Some other processing (updating microservices or the requesting process/system) happens here which also uses the balance.</li>
</ol>
</li>
<li>The system updates the users balance: <code>$user->balance -= $amount</code> (or in SQL <code>UDPATE users SET balance = balance - 100 WHERE id = :user_id</code>).</li>
</ol>
<p>That first check to see if the requested user have enough in their balance and the subtraction of the amount from the balance are two separate queries, because we also need to do some additional processing between validating the balance, and updating the database. Therefore, it was not possible to just make this a subquery of our update because that balance is also used to do some other steps between the two queries.</p>
<p>Here is some <em>poorly architected code</em> (using Laravel) for the withdrawl:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">&#x3C;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#B392F0"> App\Http\Controllers</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#79B8FF"> App\Models\User</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#79B8FF"> Illuminate\Http\Request</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> BalanceController</span><span style="color:#F97583"> extends</span><span style="color:#B392F0"> Controller</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> withdraw</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> $userId, </span><span style="color:#79B8FF">Request</span><span style="color:#E1E4E8"> $request)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        $requestedAmount </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $request</span><span style="color:#F97583">-></span><span style="color:#B392F0">input</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'requested_amount'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        // Check user has enough in balance</span></span>
<span class="line"><span style="color:#E1E4E8">        $user </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> User</span><span style="color:#F97583">::</span><span style="color:#B392F0">where</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'id'</span><span style="color:#E1E4E8">, $userId)</span><span style="color:#F97583">-></span><span style="color:#B392F0">where</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'balance'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'>='</span><span style="color:#E1E4E8">, $requestedAmount)</span><span style="color:#F97583">-></span><span style="color:#B392F0">first</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> ($user) { </span><span style="color:#6A737D">// We have enough in our balance, continue withdrawl...</span></span>
<span class="line"><span style="color:#E1E4E8">            $originalBalance </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $user</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">balance;</span></span>
<span class="line"><span style="color:#B392F0">            dispatch</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">function</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">use</span><span style="color:#E1E4E8"> ($user, $originalBalance) {</span></span>
<span class="line"><span style="color:#6A737D">                // Other processing (notifications, updating microservices or other apps etc) </span></span>
<span class="line"><span style="color:#6A737D">                // happens here which also uses the original balance (100.00)</span></span>
<span class="line"><span style="color:#E1E4E8">            });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">            // Subtrack requestedAmount from balance</span></span>
<span class="line"><span style="color:#E1E4E8">            $user</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">balance </span><span style="color:#F97583">-=</span><span style="color:#E1E4E8"> $requestedAmount;</span></span>
<span class="line"><span style="color:#E1E4E8">            $user</span><span style="color:#F97583">-></span><span style="color:#B392F0">save</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>The key thing to realize here is that once we have queried the user’s balance, we are not locking the row. This means that if two such systems try to withdraw from the balance at the same time, the first SELECT would tell them both the user has <code>100.00</code>. Subsequently, both sessions would believe they can subtract <code>100.00</code> from the balance. This would leave the balance at <code>-100.00</code> and both systems would have been approved <code>100.00</code>. This is the goal of an <a href="https://blog.acolyer.org/2017/08/07/acidrain-concurrency-related-attacks-on-database-backed-web-applications/">ACIDRain attack</a>.</p>
<p>Aside from the face that this is a poorly architected example in the first place, you might be thinking, just set the balance column as <code>UNSIGNED</code> and this would solve the problem. However, this is not a solution. The problem is not that the balance can go negative since in many system this is a requirement (overdrafts etc).</p>
<p><strong>TLDR; If you just want to see the various ways to fix/prevent this issue, skip to the “Ways to prevent ACIDRain vulnerabilities” section.</strong></p>
<h2 id="checking-for-acidrain-attack-vulnerability-in-selectupdate-sequences">Checking for ACIDRain attack vulnerability in SELECT/UPDATE sequences</h2>
<h3 id="why-go-and-not-php">Why Go and not PHP?</h3>
<h4 id="reason-1-concurrency">Reason 1: Concurrency</h4>
<p>PHP is great for many things, but it is not a good language for concurrency. It’s just not designed for that. In fact, I wouldn’t even know where to start to quickly and accurately test for this with PHP, without using AMPHP or ReactPHP. However, Go is a great language for concurrency, therefor, it is reasonably simple to test for this issue using Go with very little setup once you understand some basics of concurrency in Go.</p>
<h4 id="reason-2-go-makes-it-easy-to-access-the-database-and-run-queries">Reason 2: Go makes it easy to access the database and run queries</h4>
<p>Go is a great language for testing SQL queries in general, as it has a great SQL package out of the box. You will need to install one additional package to use Go with MySQL, but it’s just one terminal command to do this.</p>
<h4 id="reason-3-go-is-not-hard-to-use-for-php-devs">Reason 3: Go is not hard to use for PHP devs</h4>
<p>If you are a modern PHP developer (7.4+/8+), you will find Go to be a pretty easy language to learn. It has it’s quirks, but so does PHP. In this example the only library we will be using is the <code>database/sql</code> package along with the mysql driver package, which is similar to PHP’s PDO driver.</p>
<h3 id="setting-up-maingo">Setting up main.go</h3>
<p>Let’s set up our <code>main.go</code> file. This is the file which will test for the ACIDRain vulnerability.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#9ECBFF">    "</span><span style="color:#B392F0">database/sql</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#9ECBFF">    "</span><span style="color:#B392F0">fmt</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#9ECBFF">    "</span><span style="color:#B392F0">sync</span><span style="color:#9ECBFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">    _</span><span style="color:#9ECBFF"> "</span><span style="color:#B392F0">github.com/go-sql-driver/mysql</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span></code></pre>
<p>As you can see, we’re using a third-party package called <code>github.com/go-sql-driver/mysql</code> to connect to our MySQL database. You will need to install this by running the following two commands in your terminal from the same directory as your <code>main.go</code> file:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">go</span><span style="color:#9ECBFF"> get</span><span style="color:#79B8FF"> -u</span><span style="color:#9ECBFF"> github.com/go-sql-driver/mysql</span></span>
<span class="line"><span style="color:#B392F0">go</span><span style="color:#9ECBFF"> mod</span><span style="color:#9ECBFF"> tidy</span></span></code></pre>
<h3 id="connecting-to-the-db">Connecting to the DB</h3>
<p>First, let’s create a function called <code>connectDatabase</code> which will connect to our MySQL database. This function will return a pointer to a <code>sql.DB</code> object, which we will use to run our queries.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> connectDatabase</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sql.DB {</span></span>
<span class="line"><span style="color:#E1E4E8">    db, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> sql.</span><span style="color:#79B8FF">Open</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"mysql"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"root@tcp(localhost)/sql_race_tests"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error opening database: "</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Main: Opened database connection"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> db</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p><strong>NOTE: The format for the connection string is <code>username:password@tcp(hostname)/database_name</code>.</strong></p>
<h3 id="the-select-query-and-selectuser-function">The SELECT query and selectUser function</h3>
<p>Next, we add a constant with our select query and a function called <code>selectUser</code> which will run a SELECT query to get the user’s balance. This function will take a pointer to a <code>sql.DB</code> object and a channel of type <code>float32</code> as arguments. We will use the channel to send the user’s balance to the updateQuery function which will check if the balance is enough to withdraw the amount requested. We’re essentially recreating the <code>withdraw</code> query sequence from our Laravel example, without any of the additional logic.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ... import statements ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> selectQuery </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> `SELECT balance </span></span>
<span class="line"><span style="color:#9ECBFF">FROM users </span></span>
<span class="line"><span style="color:#9ECBFF">WHERE </span></span>
<span class="line"><span style="color:#9ECBFF">    id = 1 </span></span>
<span class="line"><span style="color:#9ECBFF">    AND </span></span>
<span class="line"><span style="color:#9ECBFF">    balance >= 100`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ... connectDatabase function ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> selectUser</span><span style="color:#E1E4E8">(db </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sql.DB, usersBalance </span><span style="color:#F97583">chan</span><span style="color:#F97583"> float32</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Running select query"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    rows, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> db.</span><span style="color:#79B8FF">Query</span><span style="color:#E1E4E8">(selectQuery)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error selecting balance: "</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#F97583">        return</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    defer</span><span style="color:#E1E4E8"> rows.</span><span style="color:#79B8FF">Close</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Gets next row</span></span>
<span class="line"><span style="color:#E1E4E8">    rows.</span><span style="color:#79B8FF">Next</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Get balance</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> balance </span><span style="color:#F97583">float32</span></span>
<span class="line"><span style="color:#E1E4E8">    rows.</span><span style="color:#79B8FF">Scan</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">balance)</span></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Balance: "</span><span style="color:#E1E4E8">, balance)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Set usersBalance channel to balance</span></span>
<span class="line"><span style="color:#E1E4E8">    usersBalance </span><span style="color:#F97583">&#x3C;-</span><span style="color:#E1E4E8"> balance</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="the-update-query-and-updatequery-function">The UPDATE query and updateQuery function</h3>
<p>Next, we add a constant with our update query and a function called <code>updateQuery</code> which will run an UPDATE query to subtract the amount from the user’s balance. This function will take a pointer to a <code>sql.DB</code> object, a channel of type <code>float32</code> We will use the channel to get the user’s balance which the selectUser function previously set. To ensure our select happen at the same time, and happen first, we will use a <code>sync.WaitGroup</code> to wait for the select to finish before running the updates in another WaitGroup. More on this later.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ... import statements ...</span></span>
<span class="line"><span style="color:#6A737D">// ... select query ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> updateQuery </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> `UPDATE users</span></span>
<span class="line"><span style="color:#9ECBFF">SET balance = balance - 100</span></span>
<span class="line"><span style="color:#9ECBFF">WHERE </span></span>
<span class="line"><span style="color:#9ECBFF">    id = 1`</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ... connectDatabase function ...</span></span>
<span class="line"><span style="color:#6A737D">// ... selectUser function ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> updateUser</span><span style="color:#E1E4E8">(usersBalance </span><span style="color:#F97583">chan</span><span style="color:#F97583"> float32</span><span style="color:#E1E4E8">, numSuccessfulUpdates </span><span style="color:#F97583">int64</span><span style="color:#E1E4E8">, db </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sql.DB) </span><span style="color:#F97583">int64</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    defer</span><span style="color:#F97583"> func</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> r </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> recover</span><span style="color:#E1E4E8">(); r </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Recovered from panic: "</span><span style="color:#E1E4E8">, r)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> &#x3C;-</span><span style="color:#E1E4E8">usersBalance </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 100</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Balance is less than 100...not updating balance"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> numSuccessfulUpdates</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Balance is >= 100...updating balance"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    res, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> db.</span><span style="color:#79B8FF">Exec</span><span style="color:#E1E4E8">(updateQuery)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error updating balance: "</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> numSuccessfulUpdates</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Balance updated"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    rowsAffected, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> res.</span><span style="color:#79B8FF">RowsAffected</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error getting rows affected: "</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> numSuccessfulUpdates</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Rows affected: "</span><span style="color:#E1E4E8">, rowsAffected)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> rowsAffected </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> numSuccessfulUpdates</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="checking-final-balance">Checking final balance</h3>
<p>Next, we add a function called <code>checkFinalBalance</code> which will simply run a SELECT query to get the user’s balance after the update. This function will take a pointer to a <code>sql.DB</code> object as an argument, and return a float32.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">pacakge main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ... everything else up to this point ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> checkBalance</span><span style="color:#E1E4E8">(db </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sql.DB) </span><span style="color:#F97583">float32</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Checking final balance"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> finalBalance </span><span style="color:#F97583">float32</span></span>
<span class="line"><span style="color:#E1E4E8">    err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> db.</span><span style="color:#79B8FF">QueryRow</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"SELECT balance FROM users WHERE id = 1"</span><span style="color:#E1E4E8">).</span><span style="color:#79B8FF">Scan</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">&#x26;</span><span style="color:#E1E4E8">finalBalance)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error selecting balance: "</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> finalBalance;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="putting-it-all-together">Putting it all together</h3>
<p>Rather than putting everything in the <code>main</code> function we will create a function called <code>MySQL</code> which will setup our channels, waitgroups and goroutines, and run our select and update in parallel, but in the correct order. This function will then return a float32 which will be the final balance after the update.</p>
<p><strong>NOTE: I’ve put <code>fmt.Println</code> statements in the code to show you the order in which the queries are run. This is not necessary in your own code, but it can be useful for debugging.</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> MySQL</span><span style="color:#E1E4E8">() (</span><span style="color:#F97583">float32</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">int64</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">    // 2 workers, which will run the select and update queries in parallel</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> workers </span><span style="color:#F97583">int</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 2</span></span>
<span class="line"><span style="color:#6A737D">    // userBalance channel will store the balance</span></span>
<span class="line"><span style="color:#6A737D">    // of the user between the select and update queries</span></span>
<span class="line"><span style="color:#E1E4E8">    usersBalance </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> make</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">chan</span><span style="color:#F97583"> float32</span><span style="color:#E1E4E8">, workers)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Waitgroups will ensure the selects happen before the updates</span></span>
<span class="line"><span style="color:#6A737D">    // otherwise the order would not be guaranteed</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> wg sync.WaitGroup</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    db </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> connectDatabase</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    defer</span><span style="color:#E1E4E8"> db.</span><span style="color:#79B8FF">Close</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Begin WaitGroups"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // First 2 waitgroup for the select queries</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> workers; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        wg.</span><span style="color:#79B8FF">Add</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#6A737D">        // we will run 2 select queries in parallel using goroutines</span></span>
<span class="line"><span style="color:#F97583">        go</span><span style="color:#F97583"> func</span><span style="color:#E1E4E8">(i </span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            fmt.</span><span style="color:#79B8FF">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"WaitGroup 1 Start: Worker </span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF">: Running selectUser</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, i)</span></span>
<span class="line"><span style="color:#6A737D">            // Once this go routine has completed is done this will let the next waitgroup know it can start</span></span>
<span class="line"><span style="color:#F97583">            defer</span><span style="color:#E1E4E8"> wg.</span><span style="color:#79B8FF">Done</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#79B8FF">            selectUser</span><span style="color:#E1E4E8">(db, usersBalance)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">            fmt.</span><span style="color:#79B8FF">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"WaitGroup 1 End: Worker </span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF">: Running selectUser</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, i)</span></span>
<span class="line"><span style="color:#E1E4E8">        }(i)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> numSuccessfulUpdates </span><span style="color:#F97583">int64</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#6A737D">    // Third and 4th Waitgroup for the update queries</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> workers; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        wg.</span><span style="color:#79B8FF">Add</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        go</span><span style="color:#F97583"> func</span><span style="color:#E1E4E8">(i </span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            fmt.</span><span style="color:#79B8FF">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"WaitGroup 2 Start: Worker </span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF">: Running updateUser</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, i)</span></span>
<span class="line"><span style="color:#F97583">            defer</span><span style="color:#E1E4E8"> wg.</span><span style="color:#79B8FF">Done</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">            numSuccessfulUpdates </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> updateUser</span><span style="color:#E1E4E8">(usersBalance, numSuccessfulUpdates, db) </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> numSuccessfulUpdates</span></span>
<span class="line"><span style="color:#E1E4E8">            fmt.</span><span style="color:#79B8FF">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"WaitGroup 2 End: Worker </span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF">: Running updateUser</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, i)</span></span>
<span class="line"><span style="color:#E1E4E8">        }(i)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D">    // Wait for all waitgroups to complete</span></span>
<span class="line"><span style="color:#E1E4E8">    wg.</span><span style="color:#79B8FF">Wait</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Get final balance</span></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> finalBalance </span><span style="color:#F97583">float32</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#E1E4E8">    finalBalance </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> checkBalance</span><span style="color:#E1E4E8">(db)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> finalBalance, numSuccessfulUpdates</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Next, we will add the <code>main</code> function which will call the <code>MySQL</code> function and then use the results to check if the SELECT and UPDATE queries are vulnerable to an ACIDRain attack.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">    finalBalance, numSuccessfulUpdates </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> MySQL</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Main: Final balance: "</span><span style="color:#E1E4E8">, finalBalance)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"----- PRE-FLIGHT CHECKS -----"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#6A737D">    // This prevents a false pass after a failed test, where the data was not reset</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> numSuccessfulUpdates </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">">>> PRE-FLIGHT FAILED: No updates were successful. Please check your dataset and code for issues and try again."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        return</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">">>> PRE-FLIGHT PASSED: The dataset is ready to be tested."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"----- TEST RESULTS -----"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> finalBalance </span><span style="color:#F97583">==</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">100</span><span style="color:#F97583"> &#x26;&#x26;</span><span style="color:#E1E4E8"> numSuccessfulUpdates </span><span style="color:#F97583">==</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">">>> FAIL:  This SELECT and UPDATE sequence are vulnerable to an ACIDRain Attack! Please use FOR UPDATE or FOR SHARE on the SELECT to fix this issue!"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">">>> PASS: This SELECT and UPDATE are not vulnerable to an ACIDRain Attack."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<h3 id="running-the-test">Running the test</h3>
<p>To run the test, simply run the following command in your terminal from the same directory as your <code>main.go</code> file:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">go</span><span style="color:#9ECBFF"> run</span><span style="color:#9ECBFF"> main.go</span></span></code></pre>
<h3 id="results-fail">Results: FAIL</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">Main:</span><span style="color:#9ECBFF"> Opened</span><span style="color:#9ECBFF"> database</span><span style="color:#9ECBFF"> connection</span></span>
<span class="line"><span style="color:#B392F0">Begin</span><span style="color:#9ECBFF"> WaitGroups</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 2</span><span style="color:#9ECBFF"> Start:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> updateUser</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> Start:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> selectUser</span></span>
<span class="line"><span style="color:#B392F0">Selecting</span><span style="color:#9ECBFF"> balance</span><span style="color:#9ECBFF"> from</span><span style="color:#9ECBFF"> users</span><span style="color:#9ECBFF"> table</span><span style="color:#9ECBFF"> where</span><span style="color:#9ECBFF"> id</span><span style="color:#9ECBFF"> =</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> and</span><span style="color:#9ECBFF"> balance</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">=</span><span style="color:#79B8FF"> 100</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> Start:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 0</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> selectUser</span></span>
<span class="line"><span style="color:#B392F0">Selecting</span><span style="color:#9ECBFF"> balance</span><span style="color:#9ECBFF"> from</span><span style="color:#9ECBFF"> users</span><span style="color:#9ECBFF"> table</span><span style="color:#9ECBFF"> where</span><span style="color:#9ECBFF"> id</span><span style="color:#9ECBFF"> =</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> and</span><span style="color:#9ECBFF"> balance</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">=</span><span style="color:#79B8FF"> 100</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 2</span><span style="color:#9ECBFF"> Start:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 0</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> updateUser</span></span>
<span class="line"><span style="color:#B392F0">Balance:</span><span style="color:#79B8FF">  100</span></span>
<span class="line"><span style="color:#B392F0">Balance:</span><span style="color:#79B8FF">  100</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> End:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 0</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> selectUser</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> End:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> selectUser</span></span>
<span class="line"><span style="color:#B392F0">Balance</span><span style="color:#9ECBFF"> is</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">=</span><span style="color:#79B8FF"> 100</span><span style="color:#9ECBFF">...updating</span><span style="color:#9ECBFF"> balance</span></span>
<span class="line"><span style="color:#B392F0">Balance</span><span style="color:#9ECBFF"> is</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">=</span><span style="color:#79B8FF"> 100</span><span style="color:#9ECBFF">...updating</span><span style="color:#9ECBFF"> balance</span></span>
<span class="line"><span style="color:#B392F0">Balance</span><span style="color:#9ECBFF"> updated</span></span>
<span class="line"><span style="color:#B392F0">Rows</span><span style="color:#9ECBFF"> affected:</span><span style="color:#79B8FF">  1</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 2</span><span style="color:#9ECBFF"> End:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> updateUser</span></span>
<span class="line"><span style="color:#B392F0">Balance</span><span style="color:#9ECBFF"> updated</span></span>
<span class="line"><span style="color:#B392F0">Rows</span><span style="color:#9ECBFF"> affected:</span><span style="color:#79B8FF">  1</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 2</span><span style="color:#9ECBFF"> End:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 0</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> updateUser</span></span>
<span class="line"><span style="color:#B392F0">Checking</span><span style="color:#9ECBFF"> final</span><span style="color:#9ECBFF"> balance</span></span>
<span class="line"><span style="color:#B392F0">Main:</span><span style="color:#9ECBFF"> Final</span><span style="color:#9ECBFF"> balance:</span><span style="color:#79B8FF">  -100</span></span>
<span class="line"><span style="color:#B392F0">-----</span><span style="color:#9ECBFF"> PRE-FLIGHT</span><span style="color:#9ECBFF"> CHECKS</span><span style="color:#79B8FF"> -----</span></span>
<span class="line"><span style="color:#E1E4E8">>>> </span><span style="color:#B392F0">PRE-FLIGHT</span><span style="color:#9ECBFF"> PASSED:</span><span style="color:#9ECBFF"> The</span><span style="color:#9ECBFF"> dataset</span><span style="color:#9ECBFF"> is</span><span style="color:#9ECBFF"> ready</span><span style="color:#9ECBFF"> to</span><span style="color:#9ECBFF"> be</span><span style="color:#9ECBFF"> tested.</span></span>
<span class="line"><span style="color:#B392F0">-----</span><span style="color:#9ECBFF"> TEST</span><span style="color:#9ECBFF"> RESULTS</span><span style="color:#79B8FF"> -----</span></span>
<span class="line"><span style="color:#E1E4E8">>>> </span><span style="color:#B392F0">FAIL:</span><span style="color:#9ECBFF">  This</span><span style="color:#9ECBFF"> SELECT</span><span style="color:#9ECBFF"> and</span><span style="color:#9ECBFF"> UPDATE</span><span style="color:#9ECBFF"> sequence</span><span style="color:#9ECBFF"> are</span><span style="color:#9ECBFF"> vulnerable</span><span style="color:#9ECBFF"> to</span><span style="color:#9ECBFF"> an</span><span style="color:#9ECBFF"> ACIDRain</span><span style="color:#9ECBFF"> Attack!</span><span style="color:#9ECBFF"> Please</span><span style="color:#9ECBFF"> use</span><span style="color:#9ECBFF"> FOR</span><span style="color:#9ECBFF"> UPDATE</span><span style="color:#9ECBFF"> or</span><span style="color:#9ECBFF"> FOR</span><span style="color:#9ECBFF"> SHARE</span><span style="color:#9ECBFF"> on</span><span style="color:#9ECBFF"> the</span><span style="color:#9ECBFF"> SELECT</span><span style="color:#9ECBFF"> to</span><span style="color:#9ECBFF"> fix</span><span style="color:#9ECBFF"> this</span><span style="color:#9ECBFF"> issue!</span></span></code></pre>
<p>As we can see, both WaitGroups start at the same time, but WaitGroup 2 knows to wait for WaitGroup 1 to finish before running the updates. This is because we are using a <code>sync.WaitGroup</code> to ensure the order of the queries is correct. This is important because we need to ensure the SELECT happens before the UPDATE, otherwise the order would not be guaranteed.</p>
<p>We can see the SELECT queries are both returning <code>100.00</code> and the UPDATE queries are both running and updating the balance to <code>balance - 100.00</code>. After this operation have a final balance of <code>-100.00</code> and the number of times the update was successul is 2. This is a clear indication that the SELECT and UPDATE queries are vulnerable to an ACIDRain attack.</p>
<h3 id="results-pre-flight-check-failed">Results: Pre-flight check failed</h3>
<p>If you run the script again before resetting the data the pre-flight check will fail, as the data is not in the correct state to be tested. This is why we have the pre-flight check. You could instead reset the data to the original state if you want to omit this step. I am resetting my data via laravels <code>artisan tinker</code>, so I opted not to reset it here.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#6A737D"># ... same as above ...</span></span>
<span class="line"><span style="color:#B392F0">Balance</span><span style="color:#9ECBFF"> is</span><span style="color:#9ECBFF"> less</span><span style="color:#9ECBFF"> than</span><span style="color:#79B8FF"> 100</span><span style="color:#9ECBFF">...not</span><span style="color:#9ECBFF"> updating</span><span style="color:#9ECBFF"> balance</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 2</span><span style="color:#9ECBFF"> End:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> updateUser</span></span>
<span class="line"><span style="color:#B392F0">Balance</span><span style="color:#9ECBFF"> is</span><span style="color:#9ECBFF"> less</span><span style="color:#9ECBFF"> than</span><span style="color:#79B8FF"> 100</span><span style="color:#9ECBFF">...not</span><span style="color:#9ECBFF"> updating</span><span style="color:#9ECBFF"> balance</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 2</span><span style="color:#9ECBFF"> End:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 0</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> updateUser</span></span>
<span class="line"><span style="color:#B392F0">Checking</span><span style="color:#9ECBFF"> final</span><span style="color:#9ECBFF"> balance</span></span>
<span class="line"><span style="color:#B392F0">Main:</span><span style="color:#9ECBFF"> Final</span><span style="color:#9ECBFF"> balance:</span><span style="color:#79B8FF">  -100</span></span>
<span class="line"><span style="color:#B392F0">-----</span><span style="color:#9ECBFF"> PRE-FLIGHT</span><span style="color:#9ECBFF"> CHECKS</span><span style="color:#79B8FF"> -----</span></span>
<span class="line"><span style="color:#E1E4E8">>>> </span><span style="color:#B392F0">PRE-FLIGHT</span><span style="color:#9ECBFF"> FAILED:</span><span style="color:#9ECBFF"> No</span><span style="color:#9ECBFF"> updates</span><span style="color:#9ECBFF"> were</span><span style="color:#9ECBFF"> successful.</span><span style="color:#9ECBFF"> Please</span><span style="color:#9ECBFF"> check</span><span style="color:#9ECBFF"> your</span><span style="color:#9ECBFF"> dataset</span><span style="color:#9ECBFF"> and</span><span style="color:#9ECBFF"> code</span><span style="color:#9ECBFF"> for</span><span style="color:#9ECBFF"> issues</span><span style="color:#9ECBFF"> and</span><span style="color:#9ECBFF"> try</span><span style="color:#9ECBFF"> again.</span></span></code></pre>
<h2 id="transactional-selectupdate-queries">Transactional SELECT/UPDATE queries</h2>
<p>You might be thinking, “Why not just use a transaction to lock the row until the transaction is complete?“. This is a good question, and it is part of the solution to this problem. However, it is not the full solution. With that said, we will need to add a transaction to our <code>selectUser</code> and <code>updateUser</code> functions before we can look at the complete solution.</p>
<h3 id="adding-a-transaction-to-each-goroutine">Adding a transaction to each goroutine</h3>
<p>As mentioned, a goroutine in our application can be thought of as a seperate application or user requesting to withdraw from the balance. Therefore, we need to ensure each goroutine is running in a transaction.</p>
<p>To do this we will add 3 new functions to keep things more readable, as we will potentially be using a rollback anywhere we are handling an error. These functions will be <code>beginTransaction</code>, <code>commitTransaction</code> and <code>rollbackTransaction</code>.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ... imports, connectDatabase, selectQuery, updateQuery, checkBalance ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> startTransaction</span><span style="color:#E1E4E8">(db </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sql.DB) {</span></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Starting transaction"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    _, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> db.</span><span style="color:#79B8FF">Exec</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"START TRANSACTION"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error starting transaction: "</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> rollbackTransaction</span><span style="color:#E1E4E8">(db </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sql.DB) {</span></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Rolling back transaction"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    _, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> db.</span><span style="color:#79B8FF">Exec</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"ROLLBACK"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error rolling back transaction: "</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> commitTransaction</span><span style="color:#E1E4E8">(db </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sql.DB) {</span></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Committing transaction"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    _, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> db.</span><span style="color:#79B8FF">Exec</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"COMMIT"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error committing transaction: "</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ... MySQL function ...</span></span></code></pre>
<p>Next, we will add a <code>startTransaction</code> to the goroutines calling <code>selectUser</code> and our <code>defer commitTransaction</code> to the goroutines calling <code>updateUser</code> functions. We will also add <code>rollbackTransaction</code> to the <code>updateUser</code> function where we are handling errors.</p>
<p>In our <code>MySQL</code> function:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> MySQL</span><span style="color:#E1E4E8">() (</span><span style="color:#F97583">float32</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">int64</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // ... everything before first for loop ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> workers; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        wg.</span><span style="color:#79B8FF">Add</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        go</span><span style="color:#F97583"> func</span><span style="color:#E1E4E8">(i </span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            fmt.</span><span style="color:#79B8FF">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"WaitGroup 1 Start: Worker </span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF">: Running selectUser</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, i)</span></span>
<span class="line"><span style="color:#F97583">            defer</span><span style="color:#E1E4E8"> wg.</span><span style="color:#79B8FF">Done</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#79B8FF">            startTransaction</span><span style="color:#E1E4E8">(db)</span></span>
<span class="line"><span style="color:#79B8FF">            selectUser</span><span style="color:#E1E4E8">(db, usersBalance)</span></span>
<span class="line"><span style="color:#E1E4E8">            fmt.</span><span style="color:#79B8FF">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"WaitGroup 1 End: Worker </span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF">: Running selectUser</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, i)</span></span>
<span class="line"><span style="color:#E1E4E8">        }(i)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    var</span><span style="color:#E1E4E8"> numSuccessfulUpdates </span><span style="color:#F97583">int64</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 0</span></span>
<span class="line"><span style="color:#6A737D">    // Third and 4th Waitgroup for the update queries</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> i </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">; i </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> workers; i</span><span style="color:#F97583">++</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        wg.</span><span style="color:#79B8FF">Add</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">        go</span><span style="color:#F97583"> func</span><span style="color:#E1E4E8">(i </span><span style="color:#F97583">int</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">            fmt.</span><span style="color:#79B8FF">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"WaitGroup 2 Start: Worker </span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF">: Running updateUser</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, i)</span></span>
<span class="line"><span style="color:#F97583">            defer</span><span style="color:#E1E4E8"> wg.</span><span style="color:#79B8FF">Done</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">            defer</span><span style="color:#79B8FF"> commitTransaction</span><span style="color:#E1E4E8">(db)</span></span>
<span class="line"><span style="color:#E1E4E8">            numSuccessfulUpdates </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> updateUser</span><span style="color:#E1E4E8">(usersBalance, numSuccessfulUpdates, db) </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> numSuccessfulUpdates</span></span>
<span class="line"><span style="color:#E1E4E8">            fmt.</span><span style="color:#79B8FF">Printf</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"WaitGroup 2 End: Worker </span><span style="color:#79B8FF">%d</span><span style="color:#9ECBFF">: Running updateUser</span><span style="color:#79B8FF">\n</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">, i)</span></span>
<span class="line"><span style="color:#E1E4E8">        }(i)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#6A737D">    // Wait for all waitgroups to complete</span></span>
<span class="line"><span style="color:#E1E4E8">    wg.</span><span style="color:#79B8FF">Wait</span><span style="color:#E1E4E8">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // ...</span></span></code></pre>
<p>And in our <code>updateUser</code> function:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> updateUser</span><span style="color:#E1E4E8">(usersBalance </span><span style="color:#F97583">chan</span><span style="color:#F97583"> float32</span><span style="color:#E1E4E8">, numSuccessfulUpdates </span><span style="color:#F97583">int64</span><span style="color:#E1E4E8">, db </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sql.DB) </span><span style="color:#F97583">int64</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    defer</span><span style="color:#F97583"> func</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> r </span><span style="color:#F97583">:=</span><span style="color:#79B8FF"> recover</span><span style="color:#E1E4E8">(); r </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#79B8FF">            rollbackTransaction</span><span style="color:#E1E4E8">(db)</span></span>
<span class="line"><span style="color:#E1E4E8">            fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Recovered from panic: "</span><span style="color:#E1E4E8">, r)</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> &#x3C;-</span><span style="color:#E1E4E8">usersBalance </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 100</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Balance is less than 100...not updating balance"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#79B8FF">        rollbackTransaction</span><span style="color:#E1E4E8">(db)</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> numSuccessfulUpdates</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Balance is >= 100...updating balance"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    res, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> db.</span><span style="color:#79B8FF">Exec</span><span style="color:#E1E4E8">(updateQuery)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error updating balance: "</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#79B8FF">        rollbackTransaction</span><span style="color:#E1E4E8">(db)</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> numSuccessfulUpdates</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Balance updated"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    rowsAffected, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> res.</span><span style="color:#79B8FF">RowsAffected</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error getting rows affected: "</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#79B8FF">        rollbackTransaction</span><span style="color:#E1E4E8">(db)</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> numSuccessfulUpdates</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Rows affected: "</span><span style="color:#E1E4E8">, rowsAffected)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> rowsAffected </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> numSuccessfulUpdates</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>With that we are all set to try a few approaches to prevent the ACIDRain attack.</p>
<p><strong>NOTE: Feel free to re-run the test here to confirm this alone does not fix the issue.</strong></p>
<h2 id="ways-to-prevent-acidrain-vulnerabilities">Ways to prevent ACIDRain vulnerabilities</h2>
<h3 id="method-1-use-for-update-or-for-share-in-your-select-query">Method 1: Use <code>FOR UPDATE</code> or <code>FOR SHARE</code> in your SELECT query</h3>
<p>The quickest way to prevent ACIDRain vulnerabilities is to use <code>FOR UPDATE</code> or <code>FOR SHARE</code> in your SELECT query. This will lock the row until the transaction is complete, and prevent other sessions from reading the row until the transaction is complete.</p>
<p>When to use <code>FOR UPDATE</code> or <code>FOR SHARE</code> will depend on your use case. If you’re unsure, try <code>FOR UPDATE</code> first. <code>FOR SHARE</code> is used when you want to allow other transactions to read the row, but not update it. This can be useful if you want to allow queued transactions to still perform other operations with the data before doing an update/delete. It can also be useful if you wish to allow queued transactions use the selected data for an insert or read-only operations.</p>
<p>Essentially, <code>FOR UPDATE</code> is a fully blocking operation (blocks both read and writes on rows in question), while <code>FOR SHARE</code> is a partially blocking operation (blocks only writes on rows in question).</p>
<p>You should read the MySQL documentation on both <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locks-set.html">here</a>. You should also be sure to understand the different locking behaviour defined by <code>NOWAIT</code> and <code>SKIP LOCKED</code>. You can read more about them <a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking-reads.html#innodb-locking-reads-nowait-skip-locked">here</a>.</p>
<p>Here is an example of how you would use <code>FOR UPDATE</code> in your SELECT query:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">package</span><span style="color:#B392F0"> main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// ... imports ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#E1E4E8"> selectQuery </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> `SELECT balance</span></span>
<span class="line"><span style="color:#9ECBFF">FROM users</span></span>
<span class="line"><span style="color:#9ECBFF">WHERE</span></span>
<span class="line"><span style="color:#9ECBFF">    id = 1</span></span>
<span class="line"><span style="color:#9ECBFF">    AND</span></span>
<span class="line"><span style="color:#9ECBFF">    balance >= 100</span></span>
<span class="line"><span style="color:#9ECBFF">FOR UPDATE`</span></span></code></pre>
<p>That’s it! Now when you run the test, you should see that the SELECT and UPDATE queries are no longer vulnerable to an ACIDRain attack.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#B392F0">Main:</span><span style="color:#9ECBFF"> Opened</span><span style="color:#9ECBFF"> database</span><span style="color:#9ECBFF"> connection</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 2</span><span style="color:#9ECBFF"> Start:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> updateUser</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> Start:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> selectUser</span></span>
<span class="line"><span style="color:#B392F0">Starting</span><span style="color:#9ECBFF"> transaction</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 2</span><span style="color:#9ECBFF"> Start:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 0</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> updateUser</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> Start:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 0</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> selectUser</span></span>
<span class="line"><span style="color:#B392F0">Starting</span><span style="color:#9ECBFF"> transaction</span></span>
<span class="line"><span style="color:#B392F0">Selecting</span><span style="color:#9ECBFF"> balance</span><span style="color:#9ECBFF"> from</span><span style="color:#9ECBFF"> users</span><span style="color:#9ECBFF"> table</span><span style="color:#9ECBFF"> where</span><span style="color:#9ECBFF"> id</span><span style="color:#9ECBFF"> =</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> and</span><span style="color:#9ECBFF"> balance</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">=</span><span style="color:#79B8FF"> 100</span></span>
<span class="line"><span style="color:#B392F0">Selecting</span><span style="color:#9ECBFF"> balance</span><span style="color:#9ECBFF"> from</span><span style="color:#9ECBFF"> users</span><span style="color:#9ECBFF"> table</span><span style="color:#9ECBFF"> where</span><span style="color:#9ECBFF"> id</span><span style="color:#9ECBFF"> =</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> and</span><span style="color:#9ECBFF"> balance</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">=</span><span style="color:#79B8FF"> 100</span></span>
<span class="line"><span style="color:#B392F0">Balance:</span><span style="color:#79B8FF">  100</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> End:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 0</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> selectUser</span></span>
<span class="line"><span style="color:#B392F0">Balance</span><span style="color:#9ECBFF"> is</span><span style="color:#F97583"> ></span><span style="color:#9ECBFF">=</span><span style="color:#79B8FF"> 100</span><span style="color:#9ECBFF">...updating</span><span style="color:#9ECBFF"> balance</span></span>
<span class="line"><span style="color:#B392F0">Balance</span><span style="color:#9ECBFF"> updated</span></span>
<span class="line"><span style="color:#B392F0">Rows</span><span style="color:#9ECBFF"> affected:</span><span style="color:#79B8FF">  1</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 2</span><span style="color:#9ECBFF"> End:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> updateUser</span></span>
<span class="line"><span style="color:#B392F0">Committing</span><span style="color:#9ECBFF"> transaction</span></span>
<span class="line"><span style="color:#B392F0">Balance:</span><span style="color:#79B8FF">  0</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF"> End:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 1</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> selectUser</span></span>
<span class="line"><span style="color:#B392F0">Balance</span><span style="color:#9ECBFF"> is</span><span style="color:#9ECBFF"> less</span><span style="color:#9ECBFF"> than</span><span style="color:#79B8FF"> 100</span><span style="color:#9ECBFF">...not</span><span style="color:#9ECBFF"> updating</span><span style="color:#9ECBFF"> balance</span></span>
<span class="line"><span style="color:#B392F0">Rolling</span><span style="color:#9ECBFF"> back</span><span style="color:#9ECBFF"> transaction</span></span>
<span class="line"><span style="color:#B392F0">WaitGroup</span><span style="color:#79B8FF"> 2</span><span style="color:#9ECBFF"> End:</span><span style="color:#9ECBFF"> Worker</span><span style="color:#79B8FF"> 0</span><span style="color:#9ECBFF">:</span><span style="color:#9ECBFF"> Running</span><span style="color:#9ECBFF"> updateUser</span></span>
<span class="line"><span style="color:#B392F0">Committing</span><span style="color:#9ECBFF"> transaction</span></span>
<span class="line"><span style="color:#B392F0">Checking</span><span style="color:#9ECBFF"> final</span><span style="color:#9ECBFF"> balance</span></span>
<span class="line"><span style="color:#B392F0">Main:</span><span style="color:#9ECBFF"> Final</span><span style="color:#9ECBFF"> balance:</span><span style="color:#79B8FF">  0</span></span>
<span class="line"><span style="color:#B392F0">-----</span><span style="color:#9ECBFF"> PRE-FLIGHT</span><span style="color:#9ECBFF"> CHECKS</span><span style="color:#79B8FF"> -----</span></span>
<span class="line"><span style="color:#E1E4E8">>>> </span><span style="color:#B392F0">PRE-FLIGHT</span><span style="color:#9ECBFF"> PASSED:</span><span style="color:#9ECBFF"> The</span><span style="color:#9ECBFF"> dataset</span><span style="color:#9ECBFF"> is</span><span style="color:#9ECBFF"> ready</span><span style="color:#9ECBFF"> to</span><span style="color:#9ECBFF"> be</span><span style="color:#9ECBFF"> tested.</span></span>
<span class="line"><span style="color:#B392F0">-----</span><span style="color:#9ECBFF"> TEST</span><span style="color:#9ECBFF"> RESULTS</span><span style="color:#79B8FF"> -----</span></span>
<span class="line"><span style="color:#E1E4E8">>>> </span><span style="color:#B392F0">PASS:</span><span style="color:#9ECBFF"> This</span><span style="color:#9ECBFF"> SELECT</span><span style="color:#9ECBFF"> and</span><span style="color:#9ECBFF"> UPDATE</span><span style="color:#9ECBFF"> are</span><span style="color:#9ECBFF"> not</span><span style="color:#9ECBFF"> vulnerable</span><span style="color:#9ECBFF"> to</span><span style="color:#9ECBFF"> an</span><span style="color:#9ECBFF"> ACIDRain</span><span style="color:#9ECBFF"> attack.</span></span></code></pre>
<p>We can see now only 1 transaction is able to perform an update:</p>
<ol>
<li>Both <code>Worker 1</code> and <code>Worker 2</code> start at the same time and start a transaction in their own session/goroutine.</li>
<li><em><strong>Transaction A</strong></em> (<code>WaitGroup 1 End: Worker 0:</code>) gets <code>Balance:  100</code> from the select query, this time with <code>FOR UPDATE</code>, which tells all other transactions trying to access this row while the <em><strong>Transaction A</strong></em> remains open they have to wait until the <em><strong>Transaction A</strong></em> is committed or rolled back.</li>
<li><em><strong>Transaction B</strong></em> (<code>WaitGroup 2 End: Worker 0:</code>) gets <code>Balance:  0</code> from the select query and rolls back the transaction as expected. This is because the row was locked until <em><strong>Transaction A</strong></em> was committed.</li>
</ol>
<h4 id="shared-lock-and-lock-for-update-in-laravel">Shared Lock and Lock for Update in Laravel</h4>
<p>Laravel allows you to use both <code>FOR UPDATE</code> and <code>FOR SHARE</code> in your queries. You can use the <code>sharedLock</code> method or <code>lockForUpdate</code> in your Laravel query using the Schema Builder.</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#E1E4E8">$user </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> DB</span><span style="color:#F97583">::</span><span style="color:#B392F0">table</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'users'</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">-></span><span style="color:#B392F0">where</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'id'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">-></span><span style="color:#B392F0">where</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'balance'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'>='</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">-></span><span style="color:#B392F0">sharedLock</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">-></span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#6A737D">// or</span></span>
<span class="line"><span style="color:#6A737D">// $user = DB::table('users')->where('id', 1)->where('balance', '>=', 100)->lockForUpdate()->get();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> ($user) {</span></span>
<span class="line"><span style="color:#6A737D">    // ... rest of your code ...</span></span>
<span class="line"><span style="color:#E1E4E8">    $user</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">balance </span><span style="color:#F97583">-=</span><span style="color:#E1E4E8"> $requestedAmount;</span></span>
<span class="line"><span style="color:#E1E4E8">    $user</span><span style="color:#F97583">-></span><span style="color:#B392F0">save</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>You can read more about this in the Laravel documentation <a href="https://laravel.com/docs/10.x/queries#pessimistic-locking">here</a>.</p>
<h3 id="method-2-setting-the-isolation-level-to-serializable">Method 2: Setting the isolation level to <code>SERIALIZABLE</code></h3>
<p>Another way to prevent ACIDRain vulnerabilities is to set the isolation level to <code>SERIALIZABLE</code>. This will prevent phantom reads and non-repeatable reads, and will also prevent the ACIDRain attack.</p>
<p><strong>IMPORTANT: Setting the isolation level to <code>SERIALIZABLE</code> for a session or globally will tell MtSQL to treat all select statements in a transaction as if they are a <code>SELECT...FOR SHARE</code>.</strong></p>
<p>You can set the isolation level to <code>SERIALIZABLE</code> in your MySQL connection string like so:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> connectDatabase</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sql.DB {</span></span>
<span class="line"><span style="color:#E1E4E8">    db, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> sql.</span><span style="color:#79B8FF">Open</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"mysql"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"root@tcp(localhost)/dbname?transaction_isolation='SERIALIZABLE'"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error opening database: "</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Main: Opened database connection"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> db</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>You can also set the isolation level at a session/transaction level using the <code>SET TRANSACTION</code> statement:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">func</span><span style="color:#B392F0"> startTransaction</span><span style="color:#E1E4E8">(db </span><span style="color:#F97583">*</span><span style="color:#E1E4E8">sql.DB) {</span></span>
<span class="line"><span style="color:#E1E4E8">    fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Starting transaction"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    _, err </span><span style="color:#F97583">:=</span><span style="color:#E1E4E8"> db.</span><span style="color:#79B8FF">Exec</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"SET TRANSACTION ISOLATION LEVEL SERIALIZABLE"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> err </span><span style="color:#F97583">!=</span><span style="color:#79B8FF"> nil</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        fmt.</span><span style="color:#79B8FF">Println</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Error starting transaction: "</span><span style="color:#E1E4E8">, err)</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span></code></pre>
<p>Or, if you wish to set the isolation level at a across all transactions, you can set the <code>transaction_isolation</code> in your MySQL configuration file, or via the <code>SET GLOBAL ISOLATION LEVEL SERIALIZABLE</code> statement.</p>
<p>You can rread more about this in the MySQL documentation <a href="https://dev.mysql.com/doc/refman/8.0/en/set-transaction.html">here</a>.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this post, we have learned how to use Go to test MySQL queries for the ACIDRain attack. We have also learned two ways to prevent the ACIDRain attack: using <code>FOR UPDATE</code> or <code>FOR SHARE</code> in your SELECT query, and setting the isolation level to <code>SERIALIZABLE</code>. Which method you use will depend on your use case, but both methods will prevent the ACIDRain attack.</p>  </article> </main>  </main> </div> <footer class="footer footer-center block mb-5 pt-10"> <div class="pb-2">
&copy; 2024 Luke Watts
</div> <div class="inline opacity-75"> <!-- Thanks for using this template. You can keep this line to support my work :) --> <a href="https://luke-watts.com/" target="_blank" class="font-bold">Website</a> developed by
<a href="https://github.com/lukewatts" target="_blank" class="font-bold">Luke Watts</a> </div> </footer>  </div> <div class="drawer-side z-40"> <label for="my-drawer" class="drawer-overlay"></label> <aside class="px-2 pt-2 h-auto min-h-full w-[19rem] bg-base-200 text-base-content flex flex-col"> <div class="w-fit mx-auto mt-5 mb-6"> <a href="/"> <div class="avatar transition ease-in-out hover:scale-[102%] block m-auto"> <div class="w-[8.5rem]"> <img src="/profile.png" class="mask mask-circle" alt="Profile image" width="300" height="300" loading="lazy" decoding="async"> </div> </div> </a> </div> <ul class="menu grow shrink menu-md overflow-y-auto"> <li> <a class="py-3 text-base" id="home" href="/">Home</a> </li><li> <a class="py-3 text-base" id="blog" href="/blog/">Blog</a> </li><li> <a class="py-3 text-base" id="projects" href="/projects/">Projects</a> </li><li> <a class="py-3 text-base" id="cv" href="/cv">CV</a> </li><li> <a class="py-3 text-base" id="contact" href="https://linkedin.com/in/lukewatts" target="_blank" referrerpolicy="no-referrer-when-downgrade">Contact &rarr;</a> </li> </ul> <script>(function(){const sideBarActiveItemID = undefined;
const activeClass = "bg-base-300";

const activeItemElem = document.getElementById(sideBarActiveItemID);
activeItemElem && activeItemElem.classList.add(activeClass);
})();</script> <div class="block sticky pointer-events-none bottom-10 bg-base-200 justify-center h-12 [mask-image:linear-gradient(transparent,#000000)]"></div> <div class="social-icons px-4 pb-5 pt-1 flex self-center justify-center sticky bottom-0 bg-base-200"> <a href="https://github.com/lukewatts" target="_blank" class="mx-3" aria-label="Github" title="Github"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.026 2c-5.509 0-9.974 4.465-9.974 9.974 0 4.406 2.857 8.145 6.821 9.465.499.09.679-.217.679-.481 0-.237-.008-.865-.011-1.696-2.775.602-3.361-1.338-3.361-1.338-.452-1.152-1.107-1.459-1.107-1.459-.905-.619.069-.605.069-.605 1.002.07 1.527 1.028 1.527 1.028.89 1.524 2.336 1.084 2.902.829.091-.645.351-1.085.635-1.334-2.214-.251-4.542-1.107-4.542-4.93 0-1.087.389-1.979 1.024-2.675-.101-.253-.446-1.268.099-2.64 0 0 .837-.269 2.742 1.021a9.582 9.582 0 0 1 2.496-.336 9.554 9.554 0 0 1 2.496.336c1.906-1.291 2.742-1.021 2.742-1.021.545 1.372.203 2.387.099 2.64.64.696 1.024 1.587 1.024 2.675 0 3.833-2.33 4.675-4.552 4.922.355.308.675.916.675 1.846 0 1.334-.012 2.41-.012 2.737 0 .267.178.577.687.479C19.146 20.115 22 16.379 22 11.974 22 6.465 17.535 2 12.026 2z"></path> </svg> </a> <a href="https://www.linkedin.com/in/lukewatts" target="_blank" class="mx-3" aria-label="Linkedin" title="Linkedin"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><circle cx="4.983" cy="5.009" r="2.188"></circle><path d="M9.237 8.855v12.139h3.769v-6.003c0-1.584.298-3.118 2.262-3.118 1.937 0 1.961 1.811 1.961 3.218v5.904H21v-6.657c0-3.27-.704-5.783-4.526-5.783-1.835 0-3.065 1.007-3.568 1.96h-.051v-1.66H9.237zm-6.142 0H6.87v12.139H3.095z"></path> </svg> </a> <a href="/rss.xml" target="_blank" class="mx-3" aria-label="RSS Feed" title="RSS Feed"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill: currentColor;transform: ;msFilter:;"><path d="M19 20.001C19 11.729 12.271 5 4 5v2c7.168 0 13 5.832 13 13.001h2z"></path><path d="M12 20.001h2C14 14.486 9.514 10 4 10v2c4.411 0 8 3.589 8 8.001z"></path><circle cx="6" cy="18" r="2"></circle> </svg> </a> </div> </aside> </div> </div> </body> </html>